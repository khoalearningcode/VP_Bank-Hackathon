[
  {
    "_id": "collection_appointment_decisions",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "AppointmentDecisionRaw",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "decision_id": {
              "type": "string",
              "description": "Alias cho _id, dùng để join hoặc trace cross-collection",
              "examples": ["dec_20251031_abc"]
            },
            "user_id": { "type": "string", "index": true },
            "image_hash": {
              "type": "string",
              "description": "SHA256 of uploaded image"
            },
            "ocr_raw": {
              "type": "object",
              "properties": {
                "paddle_boxes": {
                  "type": "array",
                  "items": { "type": "object" }
                },
                "tesseract_text": { "type": "string" },
                "easyocr_text": { "type": "string" }
              }
            },
            "normalized": {
              "type": "object",
              "properties": {
                "company_info": {
                  "type": "object",
                  "properties": {
                    "company_name": { "type": "string" },
                    "company_type": {
                      "type": "string",
                      "enum": [
                        "CT",
                        "TNHH",
                        "MTV",
                        "HTV",
                        "CP",
                        "PT",
                        "TM",
                        "DV",
                        "ĐT",
                        "TV",
                        "XD",
                        "VT",
                        "GP",
                        "JSC",
                        "Co LTD",
                        "HKD"
                      ]
                    },
                    "decision_number": {
                      "type": "string",
                      "description": "Số quyết định, ví dụ: 15/QĐ-CTYABC"
                    },
                    "decision_type": {
                      "type": "string",
                      "enum": ["BỔ NHIỆM", "MIỄN NHIỆM", "ĐIỀU ĐỘNG", "PHÂN CÔNG", "BỔ SUNG"]
                    },
                    "issue_date": {
                      "type": "object",
                      "properties": {
                        "day": { "type": "integer", "minimum": 1, "maximum": 31 },
                        "month": { "type": "integer", "minimum": 1, "maximum": 12 },
                        "year": { "type": "integer", "minimum": 1900 }
                      },
                      "required": ["day", "month", "year"]
                    },
                    "effective_date": {
                      "type": "object",
                      "properties": {
                        "day": { "type": "integer", "minimum": 1, "maximum": 31 },
                        "month": { "type": "integer", "minimum": 1, "maximum": 12 },
                        "year": { "type": "integer", "minimum": 1900 }
                      },
                      "required": ["day", "month", "year"]
                    },
                    "has_valid_stamp": {
                      "type": "boolean",
                      "description": "Cờ cho biết tài liệu có dấu hợp lệ hay không"
                    }
                  },
                  "required": ["company_name", "decision_number", "issue_date"]
                },
                "signing_person": {
                  "type": "object",
                  "properties": {
                    "full_name": { "type": "string", "minLength": 2 },
                    "position": { "type": "string" },
                    "signature_detected": { "type": "boolean" },
                    "authorization_rule": { "type": "string" }
                  },
                  "required": ["full_name", "position"]
                },
                "appointee": {
                  "type": "object",
                  "properties": {
                    "full_name": { "type": "string", "minLength": 3 },
                    "id_number": { "type": "string" },
                    "position": { "type": "string" },
                    "document_ref": { "type": "string" }
                  },
                  "required": ["full_name", "position"]
                }
              },
              "required": ["company_info", "signing_person", "appointee"]
            },
            "stamp": {
              "type": "object",
              "description": "Thông tin dấu mộc đỏ tròn",
              "properties": {
                "detected": { "type": "boolean" },
                "bbox": {
                  "type": "array",
                  "items": { "type": "integer" },
                  "minItems": 4,
                  "maxItems": 4,
                  "description": "[x, y, width, height]"
                },
                "color_features": {
                  "type": "object",
                  "properties": {
                    "dominant_red": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 255
                    },
                    "red_ratio": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1
                    }
                  }
                },
                "company_name_in_stamp": { "type": "string" },
                "embedding": {
                  "type": "array",
                  "items": { "type": "number" },
                  "minItems": 128,
                  "description": "Vector embedding (ResNet/CLIP/CNN custom)"
                }
              },
              "required": ["detected"]
            },
            "status": {
              "type": "string",
              "enum": ["pending", "verified", "rejected"],
              "default": "pending"
            },
            "created_at": { "type": "string", "format": "date-time" }
          },
          "required": ["_id", "user_id", "ocr_raw", "created_at"]
        },
        "jsonSample": [
          {
            "_id": "dec_20251031_abc",
            "decision_id": "dec_20251031_abc",
            "user_id": "user_001",
            "image_hash": "sha256:...",
            "ocr_raw": {
              "paddle_boxes": [],
              "tesseract_text": "CÔNG TY TNHH ABC ... BỔ NHIỆM ÔNG NGUYỄN VĂN A ...",
              "easyocr_text": "CÔNG TY TNHH ABC ... BỔ NHIỆM ÔNG NGUYỄN VĂN A ..."
            },
            "normalized": {
              "company_info": {
                "company_name": "CÔNG TY TNHH ABC",
                "company_type": "TNHH",
                "decision_number": "15/QĐ-CTYABC",
                "decision_type": "BỔ NHIỆM",
                "issue_date": { "day": 15, "month": 10, "year": 2025 },
                "effective_date": { "day": 20, "month": 10, "year": 2025 },
                "has_valid_stamp": true
              },
              "signing_person": {
                "full_name": "TRẦN VĂN B",
                "position": "GIÁM ĐỐC",
                "signature_detected": true,
                "authorization_rule": "Giám đốc có quyền ký quyết định bổ nhiệm"
              },
              "appointee": {
                "full_name": "NGUYỄN THỊ A",
                "id_number": "012345678901",
                "position": "KẾ TOÁN TRƯỞNG",
                "document_ref": "HS-2025-001"
              }
            },
            "stamp": {
              "detected": true,
              "bbox": [450, 600, 120, 120],
              "color_features": {
                "dominant_red": 220,
                "red_ratio": 0.78
              },
              "company_name_in_stamp": "CÔNG TY TNHH ABC",
              "embedding": [0.12, -0.45, 0.89]
            },
            "status": "pending",
            "created_at": "2025-10-31T10:00:00Z"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$addFields": {
                  "normalized": {
                    "$function": {
                      "body": "function(ocr) { /* Gọi BERT normalization microservice */ return normalized_result; }",
                      "args": ["$ocr_raw"],
                      "lang": "js"
                    }
                  },
                  "signing_person": {
                    "$function": {
                      "body": "function(normalized, ocrText) { return extractAndValidateSigner(normalized.company_info.company_type, ocrText); }",
                      "args": [
                        "$normalized",
                        {
                          "$concat": [
                            "$ocr_raw.tesseract_text",
                            " ",
                            "$ocr_raw.easyocr_text"
                          ]
                        }
                      ],
                      "lang": "js"
                    }
                  },
                  "stamp": {
                    "$function": {
                      "body": "function(imageBytes) { return stampData; }",
                      "args": ["$$ROOT.image_bytes"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "collection_appointment_decisions",
                  "on": "_id",
                  "whenMatched": "replace",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Chuẩn hóa OCR bằng BERT và lưu kết quả vào collection."
          }
        ]
      }
    }
  },
  {
    "_id": "collection_company_registry",
    "public": { "node_data": { "jsonSchema": {} } },
    "private": {}
  },
  {
    "_id": "collection_company_stamps",
    "public": { "node_data": { "jsonSchema": {} } },
    "private": {}
  },
  {
    "_id": "collection_identity_vneid",
    "public": { "node_data": { "jsonSchema": {} } },
    "private": {}
  },
  {
    "_id": "collection_verified_appointments",
    "_public": { "node_data": { "jsonSchema": {} } },
    "private": {}
  }
]
